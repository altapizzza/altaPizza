<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pizzeria ‚Äì Prise de commande (√Ä emporter)</title>
  <style>
    :root{
      --bg:#faf7f2; --ink:#1f2328; --brand:#e63946; --accent:#1d3557;
      --postit:#fff7f2; --postit-shadow:rgba(0,0,0,.15); --card:#ffffff;
      --ok:#2a9d8f; --warn:#f4a261;
    }
    :root.dark{
      --bg:#0f1115; --ink:#e5e7eb; --brand:#e63946; --accent:#1d4ed8;
      --postit:#fff088; --postit-shadow:rgba(0,0,0,.4); --card:#161a22;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--ink)}

    /* Bandeau post-it */
    .banner{position:sticky; top:0; z-index:50; background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.85)); backdrop-filter: blur(6px); border-bottom:1px solid #eee}
    .dark .banner{background:linear-gradient(180deg, rgba(22,26,34,.95), rgba(22,26,34,.85)); border-bottom-color:#2a2f3a}
    .banner-inner{max-width:1100px; margin:0 auto; padding:10px 16px; display:flex; gap:12px; align-items:center; overflow-x:auto}
    .banner h1{font-size:18px; margin:0 8px 0 0; white-space:nowrap}
    .order-note{flex:0 0 auto; width:220px; min-height:132px; padding:12px 12px 16px; position:relative; background:var(--postit); box-shadow:0 8px 18px -8px var(--postit-shadow), inset 0 1px 0 rgba(255,255,255,.6); border:1px solid rgba(0,0,0,.06); transform: rotate(var(--r,-1.5deg)); transform-origin: top left; clip-path: polygon(0 0, 100% 0, 100% calc(100% - 16px), calc(100% - 16px) 100%, 0 100%)}
    .order-note::after{content:""; position:absolute; right:0; bottom:0; width:0; height:0; border-width:16px 16px 0 0; border-style:solid; border-color: rgba(0,0,0,.08) transparent transparent transparent}
    .order-note:nth-child(odd){--r:1.2deg}
    .order-note header{display:flex; gap:6px; align-items:center; margin-bottom:6px}
    .badge{font-size:12px; padding:2px 6px; border-radius:999px; background:var(--warn); color:#fff}
    .badge[data-status="pr√™te"]{background:var(--ok)}
    .badge[data-status="livr√©e"]{background:#888}
    .order-note h4{margin:0; font-size:14px; font-weight:700}
    .order-note p{margin:.2em 0; font-size:13px}
    .note-actions{position:absolute; right:8px; top:8px; display:flex; gap:6px}
    .icon-btn{border:0; background:rgba(0,0,0,.08); width:26px; height:26px; border-radius:6px; cursor:pointer}
    .icon-btn:hover{background:rgba(0,0,0,.18)}
    .dark .icon-btn{background:#272b36}
    .dark .icon-btn:hover{background:#323848}

    /* Option D ‚Äî Post-it couleur claire, mais adoucie en mode nuit */
    .dark .order-note {
      background: #bfae72;
      color: #2a2a2a;
      border-color: rgba(0,0,0,.25);
      box-shadow:
        0 6px 14px -6px rgba(0,0,0,.6),
        inset 0 1px 0 rgba(255,255,255,.15);
    }
    .dark .order-note .help {
      color:#3a3a3a;
    }
    .dark .order-note::after {
      border-color: rgba(0,0,0,.35) transparent transparent transparent;
    }

    /* Mise en page */
    .wrap{max-width:1100px; margin:18px auto; padding:0 16px}
    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:18px}
    @media (max-width: 920px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card); border:1px solid #eee; border-radius:14px; box-shadow:0 10px 20px -16px rgba(0,0,0,.25)}
    .dark .card{background:var(--card); border-color:#2a2f3a}
    .card header{padding:14px 16px; border-bottom:1px solid #f0f0f0; display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap}
    .card header h2{margin:0; font-size:18px}
    .card .body{padding:16px}

    /* Tabs */
    .tabs{display:flex; gap:8px; margin:8px 0 14px}
    .tab{border:1px solid #ddd; background:#fff; padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:700}
    .tab.active{border-color:var(--brand); box-shadow:0 0 0 2px rgba(230,57,70,.12)}
    .dark .tab{background:#111827; color:#e5e7eb; border-color:#2a2f3a}

    /* Menu grid */
    .menu-grid{display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:14px}
    @media (max-width: 900px){.menu-grid{grid-template-columns: repeat(2, minmax(0,1fr))}}
    @media (max-width: 520px){.menu-grid{grid-template-columns: 1fr}}
    .item-card{position:relative; background:#fff; border:1px solid #eee; border-radius:14px; padding:8px; display:flex; gap:12px; align-items:flex-start}
    .dark .item-card{background:var(--card); border-color:#2a2f3a}
    .item-illus{font-size:34px; line-height:1; width:46px; height:46px; display:grid; place-items:center}
    .item-info h4{margin:0 0 6px; font-size:15px}
    .quick-actions{display:flex; gap:6px; margin-top:4px; flex-direction:column}
    .chip-btn{border:1px solid #ddd; background:#fff; padding:6px 10px; border-radius:999px; cursor:pointer; font-weight:600}
    .chip-btn:hover{border-color:#bbb}
    .dark .chip-btn{background:#111827; color:#e5e7eb; border-color:#2a2f3a}
    .chip-btn.emph{background:#fde8e8; border-color:#e63946; color:#b91c1c}
    .dark .chip-btn.emph{background:#3a1a1a; border-color:#e63946; color:#f8d7da}

    .btn{appearance:none; border:0; background:var(--brand); color:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700}
    .btn.secondary{background:var(--accent)}
    .btn.ghost{background:#f5f5f5; color:#333}
    .dark .btn.ghost{background:#1f2937; color:#e5e7eb}

    input[type="time"], select{font:inherit}
    .dark select, .dark input, .dark textarea{background:#111827; color:#e5e7eb; border-color:#2a2f3a}

    table{width:100%; border-collapse:collapse}
    th, td{text-align:left; padding:10px; border-bottom:1px solid #f1f1f1}
    .dark table th, .dark table td{border-bottom-color:#2a2f3a}
    tfoot td{font-weight:800}
    .help{font-size:13px; opacity:.8}

    /* Healthbar */
    .healthbar{position:fixed; left:50%; transform:translateX(-50%); top:10px; z-index:2000; padding:8px 12px; border-radius:10px; border:1px solid #ef4444; background:#fee2e2; color:#7f1d1d; box-shadow:0 8px 18px -8px rgba(0,0,0,.25)}
    .healthbar.ok{border-color:#22c55e; background:#dcfce7; color:#166534}
    .dark .healthbar{background:#3b0d0d; color:#fecaca; border-color:#ef4444}
    .dark .healthbar.ok{background:#052e16; color:#bbf7d0; border-color:#22c55e}

    /* Stats UI */
    .stats-cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-bottom:12px}
    .stats-card{background:var(--card);border:1px solid #eee;border-radius:12px;padding:12px}
    .dark .stats-card{border-color:#2a2f3a}
    .stats-card h4{margin:0 0 6px;font-size:13px;opacity:.8}
    .stats-card .v{font-size:18px;font-weight:800}
    .stats-table{margin-top:12px}
    .stats-table .bar{height:10px;border-radius:999px;background:#e5e7eb}
    .dark .stats-table .bar{background:#1f2937}
    .stats-table .bar > span{display:block;height:100%;border-radius:999px;background:var(--accent)}

    /* Liser√© rouge (champs requis vides) + shake */
    .input-invalid{border-color:#ef4444 !important; box-shadow:0 0 0 2px rgba(239,68,68,.12)}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
    .shake{animation:shake .28s ease}

    /* ===== Modals ===== */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.25); z-index:1000}
    .modal.open{ display:flex !important; }
    .modal-panel{background:#fff; width:min(780px, 94vw); max-height:90vh; border-radius:16px; border:1px solid #eee; box-shadow:0 30px 50px -30px rgba(0,0,0,.45); overflow:auto}
    .modal-panel.large{width:min(1000px,96vw);}
    .dark .modal-panel{ background:var(--card); border-color:#2a2f3a}
    .modal header{position:sticky; top:0; padding:14px 16px; border-bottom:1px solid #f0f0f0; display:flex; justify-content:space-between; align-items:center; background:inherit; z-index:1}
    .modal .body{padding:16px}
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    @media (max-width:640px){ .row{ grid-template-columns:1fr } }
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border:1px solid #ddd; border-radius:999px; background:#fff; cursor:pointer}
    .chip input{accent-color:var(--brand)}
    .dark .chip{background:#111827; color:#e5e7eb; border-color:#2a2f3a}
    textarea.json-editor{width:100%; min-height:360px; font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:13px; padding:12px; border:1px solid #ddd; border-radius:12px}
    .dark textarea.json-editor{background:#111827; color:#e5e7eb; border-color:#2a2f3a}
    .dark input,
    .dark textarea,
    .dark select {
      color: #fff !important;
      background-color: #222 !important;
      border-color: #555 !important;
    }
    .dark input::placeholder,
    .dark textarea::placeholder {
      color: #bbb !important;
    }
    .dark .modal .body {
      color: #fff !important;
    }
    .dark #client,
    .dark #phone {
      color: #fff !important;
      background-color: #222 !important;
    }

    /* Tableau aper√ßu export */
    .table-export{width:100%; border-collapse:collapse; font-size:13px}
    .table-export th, .table-export td{border:1px solid #e5e7eb; padding:6px 8px; text-align:left}
    .dark .table-export th, .dark .table-export td{border-color:#2a2f3a}
    .table-export thead{background:#f9fafb}
    .dark .table-export thead{background:#111827}
  </style>
</head>
<body>
  <!-- Bandeau post-it -->
  <div class="banner" id="banner">
    <div class="banner-inner">
      <h1>üóíÔ∏è Commandes enregistr√©es</h1>
      <select id="filterSlot" style="padding:6px 10px; border-radius:999px; border:1px solid #ddd; background:white; font-size:13px; flex:0 0 auto">
        <option value="">Tous les cr√©neaux</option>
      </select>
      <div id="savedOrders" style="display:flex; gap:12px"></div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- Menu visuel -->
      <section class="card" aria-labelledby="menu-title">
        <header>
          <h2 id="menu-title">Menu ‚Äì √Ä emporter</h2>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <div class="tabs">
              <button class="tab active" data-cat="pizzas">üçï Pizzas</button>
              <button class="tab" data-cat="boissons">ü•§ Boissons</button>
              <button class="tab" data-cat="desserts">üç∞ Desserts</button>
            </div>
            <input id="client" type="text" placeholder="Nom du client (obligatoire)" style="padding:10px 12px; border:1px solid #ddd; border-radius:10px; background:white"/>
            <input id="phone" type="tel" placeholder="T√©l√©phone (obligatoire)" style="padding:10px 12px; border:1px solid #ddd; border-radius:10px; background:white; width:150px"/>
            <select id="slot" title="Cr√©neau de retrait" style="padding:10px 12px; border:1px solid #ddd; border-radius:10px">
              <option value="">Cr√©neau (18:30‚Äì23:00)</option>
            </select>

            <!-- Menus d√©roulants suggestion client / t√©l√©phone -->
            <select id="nameSuggestions" style="display:none; padding:6px 8px; border-radius:8px; border:1px solid #ddd; background:white; font-size:13px;">
              <option value="">S√©lectionner un client‚Ä¶</option>
            </select>
            <select id="phoneSuggestions" style="display:none; padding:6px 8px; border-radius:8px; border:1px solid #ddd; background:white; font-size:13px;">
              <option value="">S√©lectionner un num√©ro‚Ä¶</option>
            </select>

            <button class="btn ghost" id="resetOrder">Reset Panier</button>
            <button class="btn secondary" id="saveOrder">Enregistrer la commande</button>
            <button class="btn ghost" id="toggleTheme" title="Mode sombre">üåô</button>
            <button class="btn" id="openAdmin">Admin</button>
            <button class="btn ghost" id="openStats" title="Statistiques du jour">Stats</button>
            <button class="btn ghost" id="openArchive" title="Commandes livr√©es">Historique</button>
          </div>
        </header>
        <div class="body">
          <div class="menu-grid" id="menuGrid"></div>
        </div>
      </section>

      <!-- Panier -->
      <aside class="card">
        <header><h2>Panier</h2></header>
        <div class="body">
          <div class="card" style="border:1px dashed #ddd; box-shadow:none">
            <div class="body" style="padding:0">
              <table id="orderTable" aria-label="D√©tails de la commande">
                <thead>
                  <tr><th>Article</th><th>Qt√©</th><th>Prix</th><th></th></tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr><td colspan="2">Total</td><td id="grandTotal" style="font-size:18px">0,00‚Ç¨</td><td></td></tr>
                </tfoot>
              </table>
            </div>
          </div>
          <p class="help">Commande par d√©faut : <strong>√† emporter</strong>.</p>
          <button class="btn ghost" id="exportJSON">Sauvegarde System</button>
          <div id="lastBackupInfo" style="font-size: 0.8rem; opacity: 0.7; margin-top: 4px;"></div>
          <button class="btn ghost" id="exportCSV">Exporter (CSV)</button>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal configurateur -->
  <div class="modal" id="configModal" aria-hidden="true" role="dialog" aria-labelledby="cfgTitle">
    <div class="modal-panel">
      <header>
        <h3 id="cfgTitle" style="margin:0">Configurer votre pizza</h3>
        <button class="icon-btn" id="closeCfg" aria-label="Fermer">‚úï</button>
      </header>
      <div class="body">
        <div id="cfgDesc" class="help" style="margin-bottom:10px"></div>
        <div class="row">
          <div>
            <label>Taille</label>
            <div class="quick-actions">
              <button class="chip-btn emph" data-size="grande">Grande</button>
              <button class="chip-btn" data-size="petite">Petite</button>
            </div>
          </div>
          <div>
            <label>Quantit√©</label>
            <div style="display:flex; gap:8px; align-items:center">
              <button class="chip-btn" id="qtyMinus">‚àí</button>
              <input type="number" id="cfgQty" min="1" value="1" style="width:80px; padding:8px 10px; border:1px solid #ddd; border-radius:10px"/>
              <button class="chip-btn" id="qtyPlus">+</button>
            </div>
          </div>
        </div>
        <div style="height:10px"></div>
        <label>Suppl√©ments (<span id="topPriceLabel">1,50‚Ç¨</span> chacun)</label>
        <div class="chips" id="cfgToppings"></div>
        <div style="height:10px"></div>
        <label for="notes">Notes</label>
        <textarea id="notes" placeholder="Sans oignons, bien cuite‚Ä¶" style="width:100%; min-height:70px; padding:10px 12px; border:1px solid:#ddd; border-radius:10px"></textarea>
        <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:12px">
          <div class="help" id="cfgPrice"></div>
          <div style="display:flex; gap:8px">
            <button class="btn ghost" id="cancelCfg">Annuler</button>
            <button class="btn" id="addCfg">Ajouter au panier</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Admin -->
  <div class="modal" id="adminModal" aria-hidden="true" role="dialog" aria-labelledby="adminTitle">
    <div class="modal-panel">
      <header>
        <h3 id="adminTitle" style="margin:0">Administration du catalogue</h3>
        <button class="icon-btn" id="closeAdmin" aria-label="Fermer">‚úï</button>
      </header>
      <div class="body">
        <p class="help">Modifie le JSON puis clique sur ¬´ Enregistrer le catalogue ¬ª. Tu peux aussi exporter ou r√©initialiser aux valeurs par d√©faut.</p>

        <!-- Toggle d√©verrouillage cr√©neaux -->
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="unlockToggle" />
            <span>D√©verrouiller les cr√©neaux (autoriser cr√©neaux complets/pass√©s)</span>
          </label>
        </div>

        <textarea id="adminJson" class="json-editor" spellcheck="false"></textarea>
        <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap">
          <button class="btn" id="saveCatalog">Enregistrer le catalogue</button>
          <button class="btn ghost" id="exportCatalog">Exporter</button>
          <button class="btn secondary" id="resetCatalog">R√©initialiser</button>
        </div>

        <!-- Fichier clients -->
        <h4 style="margin:18px 0 6px">Fichier clients</h4>
        <p class="help">Liste des clients connus (nom, t√©l√©phone, nombre de commandes, derni√®re commande).</p>
        <div style="display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap">
          <button class="btn ghost" id="exportClients">Exporter les clients (CSV)</button>
          <button class="btn" id="refreshClients">Actualiser</button>
          <button class="btn secondary" id="clearClients">Vider le fichier clients</button>
        </div>
        <div id="clientsAdmin" class="help"></div>
      </div>
    </div>
  </div>

  <!-- Modal Stats -->
  <div class="modal" id="statsModal" aria-hidden="true" role="dialog" aria-labelledby="statsTitle">
    <div class="modal-panel">
      <header>
        <h3 id="statsTitle" style="margin:0">Statistiques</h3>
        <button class="icon-btn" id="closeStats" aria-label="Fermer">‚úï</button>
      </header>
      <div class="body">
        <!-- Filtres p√©riode + exports principaux -->
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap">
          <input type="date" id="statsStart" />
          <input type="date" id="statsEnd" />
          <button class="btn ghost" id="statsToday" title="Revenir √† aujourd‚Äôhui">Aujourd‚Äôhui</button>
          <button class="btn ghost" id="statsThisMonth" title="Ce mois">Ce mois</button>
          <div style="flex:1"></div>
          <button class="btn ghost" id="exportStats" title="Exporter les stats (CSV)">Cr√©neaux</button>
          <button class="btn ghost" id="exportDrinksDesserts" title="Exporter boissons & desserts (CSV)">Boissons & desserts</button>
        </div>

        <!-- Ligne d‚Äôexports m√©tiers -->
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap">
          <button class="btn ghost" id="exportDailyTypes" title="R√©sum√© journalier par type">R√©sum√© journalier</button>
          <button class="btn ghost" id="exportTopClients" title="Top clients">Top clients</button>
          <button class="btn ghost" id="exportAvgSlot" title="Panier moyen par cr√©neau">Panier par cr√©neau</button>
          <button class="btn ghost" id="exportProductMix" title="Mix produits">Mix produits</button>
          <button class="btn ghost" id="exportWeekday" title="Ventes par jour de la semaine">Jours de semaine</button>
          <button class="btn ghost" id="exportTicketsChrono" title="Valeur tickets">Tickets chrono</button>
          <button class="btn ghost" id="exportMonthlyCompare" title="Comparatif mois">Mois N / N-1</button>
        </div>

        <div id="statsContent" class="help"></div>
      </div>
    </div>
  </div>

  <!-- Modal Historique -->
  <div class="modal" id="archiveModal" aria-hidden="true" role="dialog" aria-labelledby="archiveTitle">
    <div class="modal-panel">
      <header>
        <h3 id="archiveTitle" style="margin:0">Historique ‚Äì commandes livr√©es</h3>
        <button class="icon-btn" id="closeArchive" aria-label="Fermer">‚úï</button>
      </header>
      <div class="body">
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap">
          <input type="date" id="archiveStart" />
          <input type="date" id="archiveEnd" />
          <button class="btn ghost" id="archiveToday" title="Aujourd‚Äôhui">Aujourd‚Äôhui</button>
          <button class="btn ghost" id="archiveThisMonth" title="Afficher le mois en cours">Ce mois</button>

          <span class="help" id="archiveCount"></span>

          <div style="flex:1"></div>

          <div class="tabs" id="archiveViewTabs">
            <button class="tab active" id="archiveViewDetail">D√©tail</button>
            <button class="tab" id="archiveViewDaily">Journalier</button>
          </div>

          <button class="btn ghost" id="exportArchive" title="Exporter l‚Äôhistorique (CSV)">Exporter</button>
          <button class="btn" id="clearArchive" title="Supprimer d√©finitivement l‚Äôhistorique" style="display:none">Vider l‚Äôhistorique</button>
        </div>

        <div id="archiveContent" class="help"></div>
      </div>
    </div>
  </div>

  <!-- Modal aper√ßu exports -->
  <div class="modal" id="exportPreviewModal" aria-hidden="true" role="dialog">
    <div class="modal-panel large">
      <header>
        <h3 id="exportPreviewTitle">Aper√ßu export</h3>
        <button class="icon-btn" id="closeExportPreview" aria-label="Fermer">‚úï</button>
      </header>
      <div class="body">
        <div id="exportPreviewContent" class="help" style="max-height:60vh; overflow:auto;"></div>
        <div style="margin-top:12px; display:flex; justify-content:flex-end">
          <button class="btn" id="exportPreviewDownload">Exporter en CSV</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Polyfill structuredClone pour anciens iPad / Safari
    if (typeof structuredClone !== 'function') {
      window.structuredClone = (obj) => JSON.parse(JSON.stringify(obj));
    }

    /* ===== Helpers ===== */
    if(!(window.crypto && 'randomUUID' in window.crypto)){
      window.crypto = window.crypto || {};
      window.crypto.randomUUID = function(){
        const arr = new Uint8Array(16);
        (window.crypto.getRandomValues? window.crypto.getRandomValues(arr) : arr.forEach((_,i)=>arr[i]=Math.floor(Math.random()*256)));
        const s = Array.from(arr).map(b=>b.toString(16).padStart(2,'0')).join('');
        return `${s.slice(0,8)}-${s.slice(8,12)}-${s.slice(12,16)}-${s.slice(16,20)}-${s.slice(20)}`;
      };
    }
    const euro = (n)=> n.toLocaleString('fr-FR',{style:'currency',currency:'EUR'});
    const byId = (id)=> document.getElementById(id);

    let HEALTH_DEFAULT_MS = 4000;
    function showHealth(message, type='error', ms = HEALTH_DEFAULT_MS){
      let el = document.getElementById('healthbar');
      if(!el){
        el = document.createElement('div');
        el.id = 'healthbar';
        el.className = 'healthbar';
        document.body.appendChild(el);
      }
      el.textContent = message;
      el.className = type==='ok' ? 'healthbar ok' : 'healthbar';
      el.style.display = 'block';
      clearTimeout(el._t);
      el._t = setTimeout(()=>{ el.style.display='none'; }, ms);
    }

    function getPreferredTheme(){
      const s = localStorage.getItem('pizzeria.theme');
      if(s==='dark' || s==='light') return s;
      return (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light';
    }
    function applyTheme(mode, persist){
      document.documentElement.classList.toggle('dark', mode==='dark');
      if(persist) localStorage.setItem('pizzeria.theme', mode);
      const t = byId('toggleTheme');
      if(t){ t.textContent = (mode==='dark') ? '‚òÄÔ∏è' : 'üåô'; t.title = (mode==='dark') ? 'Mode clair' : 'Mode sombre'; }
    }

    /* ===== Tickets ===== */
    function todayKey(){ const d=new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
    function loadTicketState(){ const date=localStorage.getItem('pizzeria.ticketDate'); const seq=parseInt(localStorage.getItem('pizzeria.ticketSeq')||'0',10); return {date, seq: isNaN(seq)?0:seq}; }
    function nextTicket(){ const today=todayKey(); let {date,seq}=loadTicketState(); if(date!==today){ date=today; seq=0; } seq+=1; localStorage.setItem('pizzeria.ticketDate', date); localStorage.setItem('pizzeria.ticketSeq', String(seq)); return 'T-'+String(seq).padStart(2,'0'); }

    /* ===== Catalogue ===== */
    const DEFAULT_CATALOG = {
      pizzas: [
        { id:'margherita', emoji:'üçÖ', name:'Margherita', desc:'Tomate, mozzarella, basilic', base:{petite:7.0, grande:10.5} },
        { id:'regina', emoji:'üëë', name:'Reine', desc:'Jambon, champignons, mozzarella', base:{petite:7.0, grande:12} },
        { id:'4from', emoji:'üßÄ', name:'4 Fromages', desc:'Mozzarella, gorgonzola, emmental, ch√®vre', base:{petite:7.0, grande:12.5} },
        { id:'pep', emoji:'üå∂Ô∏è', name:'Pepperoni', desc:'Tomate, mozzarella, pepperoni', base:{petite:7.0, grande:12.5} },
        { id:'veg', emoji:'ü•¶', name:'V√©g√©tarienne', desc:'L√©gumes de saison, mozzarella', base:{petite:7.0, grande:12.2} }
      ],
      drinks: [
        { id:'cola33', emoji:'ü•§', name:'Coca-Cola 33cl', price:2.5 },
        { id:'cola15', emoji:'ü•§', name:'Coca-Cola 1.5L', price:3.5 },
        { id:'eau50', emoji:'üíß', name:'Eau 50cl', price:1.5 },
        { id:'perrier50', emoji:'üíß', name:'Perrier 50cl', price:2.0 },
        { id:'ice-tea33', emoji:'ü•§', name:'Ice Tea 33cl', price:2.5 }
      ],
      desserts: [
        { id:'tiramisu', emoji:'üç∞', name:'Tiramisu', price:3.5 },
        { id:'fondant', emoji:'üç´', name:'Fondant chocolat', price:3.8 },
        { id:'glace', emoji:'üç®', name:'Glace (2 boules)', price:3.2 }
      ],
      toppings: ['Olives','Oignons','Poivrons','Anchois','Champignons','Chorizo','Roquette','Burrata'],
      toppingPrice: 1.5
    };
    let CATALOG = structuredClone(DEFAULT_CATALOG);
    function loadCatalog(){ try{ const raw = localStorage.getItem('pizzeria.catalog'); if(raw){ CATALOG = JSON.parse(raw); } }catch(e){ console.warn('Catalog parse error', e); } }
    function saveCatalog(){ localStorage.setItem('pizzeria.catalog', JSON.stringify(CATALOG)); }

    /* ===== √âtats ===== */
    let currentItems = [];
    let savedOrders = [];
    let archivedOrders = [];
    let archiveDeleteMode = false;
    let cfg = { pizzaId:null, size:'petite', qty:1, toppings:[] };
    let currentCategory = 'pizzas';
    let editingOrderId = null;
    let archiveViewMode = 'detail'; // 'detail' ou 'daily'

    // Fichier clients (local)
    let clients = [];

    // Mode d√©verrouillage des cr√©neaux (stock√©)
    let unlockSlots = JSON.parse(localStorage.getItem('pizzeria.unlock') || 'false');

    /* ===== Helpers exports & stats ===== */
    let currentPreviewCSV = ''; // pour la modale d‚Äôaper√ßu exports

    function csvEscape(v){
      const str = String(v == null ? '' : v);
      return /[;"\n]/.test(str) ? '"' + str.replace(/"/g, '""') + '"' : str;
    }
    function rowsToCSV(rows){
      return rows.map(r => r.map(csvEscape).join(';')).join('\n');
    }
    function rowsToHTMLTable(rows){
      if (!rows.length) return '<p>Aucune donn√©e</p>';
      const header = rows[0];
      const body   = rows.slice(1);
      let html = '<table class="table-export"><thead><tr>';
      header.forEach(h => html += `<th>${h}</th>`);
      html += '</tr></thead><tbody>';
      body.forEach(r => {
        html += '<tr>';
        r.forEach(c => html += `<td>${c}</td>`);
        html += '</tr>';
      });
      html += '</tbody></table>';
      return html;
    }
    function openExportPreview({ title, html, csv }){
      currentPreviewCSV = csv;
      byId('exportPreviewTitle').textContent = title;
      byId('exportPreviewContent').innerHTML = html;
      byId('exportPreviewModal').classList.add('open');
    }
    function closeExportPreview(){
      byId('exportPreviewModal').classList.remove('open');
    }

    /* ===== Persistance commandes / archives ===== */
    function saveOrders(){ localStorage.setItem('pizzeria.orders', JSON.stringify(savedOrders)); }
    function loadOrders(){ savedOrders = JSON.parse(localStorage.getItem('pizzeria.orders')||'[]'); renderSavedOrders(); updateSlotsCapacity(); }
    function saveArchived(){ localStorage.setItem('pizzeria.archived', JSON.stringify(archivedOrders)); }
    function loadArchived(){ archivedOrders = JSON.parse(localStorage.getItem('pizzeria.archived')||'[]'); }

    // Sauvegarde panier
    function saveCart(){ localStorage.setItem('pizzeria.cart', JSON.stringify(currentItems)); }
    function loadCart(){ try{ const raw=localStorage.getItem('pizzeria.cart'); if(raw){ currentItems=JSON.parse(raw)||[]; } }catch(_){ currentItems=[]; } }

    // Clients (localStorage)
    function loadClients(){
      try{
        const raw = localStorage.getItem('pizzeria.clients');
        const arr = raw ? JSON.parse(raw) : [];
        clients = Array.isArray(arr) ? arr : [];
      }catch(_){
        clients = [];
      }
    }
    function saveClients(){
      localStorage.setItem('pizzeria.clients', JSON.stringify(clients));
    }
    function normalizeName(s){ return (s||'').trim().toLowerCase(); }
    function normalizePhone(s){ return (s||'').replace(/\D/g,''); }

    function rememberClient(name, phone){
      const n = (name||'').trim();
      const p = (phone||'').trim();
      if(!n || !p) return;

      const now = new Date().toISOString();
      const normPhone = normalizePhone(p);
      const normName  = normalizeName(n);

      let existing = clients.find(c => normalizeName(c.name) === normName);
      if(!existing){
        existing = clients.find(c => normalizePhone(c.phone) === normPhone);
      }

      if(existing){
        existing.name = n;
        existing.phone = p;
        existing.lastOrderAt = now;
        existing.count = (existing.count||0)+1;
      }else{
        clients.push({
          id: crypto.randomUUID(),
          name: n,
          phone: p,
          createdAt: now,
          lastOrderAt: now,
          count: 1
        });
      }
      saveClients();
      const admin = byId('adminModal');
      if(admin && admin.classList.contains('open')){
        renderClientsAdmin();
      }
    }

    /* ===== Cr√©neaux / Capacit√© ===== */
    const SLOT_CAP = 4;
    function countPizzasIn(items){
      return (items || []).reduce((s, l) => {
        const isPizza = !!(l.pizzaId || l.kind === 'pizza');
        return s + (isPizza ? (Number(l.qty) || 0) : 0);
      }, 0);
    }
    function countByKindIn(items, kind){
      return (items || []).reduce((s, l) => {
        return lineKind(l) === kind ? s + (Number(l.qty) || 0) : s;
      }, 0);
    }
    function countDrinksIn(items){ return countByKindIn(items, 'drink'); }
    function countDessertsIn(items){ return countByKindIn(items, 'dessert'); }

    function pizzasBookedForSlot(slot, excludeId){
      return savedOrders
        .filter(o=>o.slot===slot && o.id !== excludeId)
        .reduce((s,o)=> s + countPizzasIn(o.items), 0);
    }
    function pizzasInCart(){ return countPizzasIn(currentItems); }

    function buildSlots(){
      const sel = byId('slot');
      const previous = sel.value;
      sel.innerHTML = '<option value="">Cr√©neau (18:30‚Äì23:00)</option>';
      const now = new Date();
      const start = new Date(now); start.setHours(18,30,0,0);
      const end = new Date(now); end.setHours(23,0,0,0);
      for(let t = new Date(start); t <= end; t = new Date(t.getTime()+10*60000)){
        const label = t.toLocaleTimeString('fr-FR',{hour:'2-digit', minute:'2-digit'});
        const booked = pizzasBookedForSlot(label, editingOrderId || undefined);
        const full = booked >= SLOT_CAP;
        const past = t.getTime() < now.getTime();
        const opt = document.createElement('option');
        opt.value = label;
        let suffix = ` (${booked}/${SLOT_CAP} pizzas)`;
        if(full) suffix = ` (${booked}/${SLOT_CAP} pizzas ‚Äì complet)`;
        if(past) suffix += ' ‚Äî pass√©';
        const disabled = !unlockSlots && (full || past);
        opt.disabled = disabled;
        opt.textContent = label + suffix + (unlockSlots && (full || past) ? ' ‚Äî d√©verrouill√©' : '');
        sel.appendChild(opt);
      }
      if(previous){ sel.value = previous; }
    }
    function updateSlotsCapacity(){ buildSlots(); }

    /* ===== Menu ===== */
    function renderMenu(){
      const grid = byId('menuGrid'); grid.innerHTML='';
      if(currentCategory==='pizzas'){
        CATALOG.pizzas.forEach(p=> grid.appendChild(pizzaCard(p)) );
      } else if(currentCategory==='boissons'){
        CATALOG.drinks.forEach(d=> grid.appendChild(simpleItemCard(d, 'drink')) );
      } else if(currentCategory==='desserts'){
        CATALOG.desserts.forEach(d=> grid.appendChild(simpleItemCard(d, 'dessert')) );
      }
    }

    function pizzaCard(p){
      const card = document.createElement('article');
      card.className = 'item-card';
      card.style.padding = '8px';
      card.innerHTML = `
        <div class="item-illus">${p.emoji || 'üçï'}</div>
        <div class="item-info" style="flex:1">
          <h4 style="margin-bottom:6px; font-size:15px">${p.name}</h4>
          <div class="quick-actions" style="margin-top:4px; flex-direction:column; gap:6px">
            <div style="display:flex; gap:6px; flex-wrap:wrap">
              <button class="chip-btn emph" data-id="${p.id}" data-size="grande">Grande</button>
            </div>
            <div style="display:flex; gap:6px; flex-wrap:wrap">
              <button class="chip-btn" data-id="${p.id}" data-size="petite">Petite</button>
              <button class="chip-btn" data-id="${p.id}" data-size="cfg">Supp‚Ä¶</button>
            </div>
          </div>
        </div>`;
      card.querySelectorAll('.chip-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          const id = e.currentTarget.getAttribute('data-id');
          const size = e.currentTarget.getAttribute('data-size');
          if (size === 'cfg') { openConfigurator(id); return; }
          if (!size) return;
          quickAddPizza(id, size);
        });
      });
      return card;
    }

    function simpleItemCard(item, kind){
      const card = document.createElement('article'); card.className='item-card';
      card.innerHTML = `
        <div class="item-illus">${item.emoji||'üßÅ'}</div>
        <div class="item-info" style="flex:1">
          <h4>${item.name}</h4>
          <div class="quick-actions">
            <button class="chip-btn" data-id="${item.id}" data-kind="${kind}">Ajouter</button>
          </div>
        </div>`;
      card.querySelector('button').addEventListener('click', ()=> quickAddSimple(item.id, kind) );
      return card;
    }

    function addOrIncrement(key, create){
      const found = currentItems.find(l=> l.key===key);
      if(found){ found.qty += 1; renderOrderTable(); return; }
      const line = create(); line.key = key; currentItems.push(line); renderOrderTable();
    }

    function quickAddPizza(pizzaId, size){
      const p = CATALOG.pizzas.find(x=>x.id===pizzaId); if(!p) return;
      const key = `pizza:${pizzaId}:${size}:none`;
      addOrIncrement(key, ()=>({
        id: crypto.randomUUID(),
        kind: 'pizza',
        pizzaId,
        name: p.name,
        size,
        qty: 1,
        toppings: [],
        unitPrice: p.base[size]
      }));
    }

    function quickAddSimple(id, kind){
      if(kind==='drink'){
        const d = CATALOG.drinks.find(x=>x.id===id); if(!d) return;
        const key = `drink:${id}`;
        addOrIncrement(key, ()=>({
          id: crypto.randomUUID(),
          kind: 'drink',
          name: d.name,
          size: '',
          qty: 1,
          toppings: [],
          unitPrice: d.price
        }));
      } else if(kind==='dessert'){
        const ds = CATALOG.desserts.find(x=>x.id===id); if(!ds) return;
        const key = `dessert:${id}`;
        addOrIncrement(key, ()=>({
          id: crypto.randomUUID(),
          kind: 'dessert',
          name: ds.name,
          size: '',
          qty: 1,
          toppings: [],
          unitPrice: ds.price
        }));
      }
    }

    /* ===== Configurateur ===== */
    function openConfigurator(pizzaId){
      cfg = { pizzaId, size:'grande', qty:1, toppings:[] };
      const p = CATALOG.pizzas.find(x=>x.id===pizzaId);
      byId('cfgTitle').textContent = `Configurer : ${p.name}`;
      byId('cfgDesc').textContent = p.desc || '';
      byId('cfgQty').value = 1; byId('notes').value='';
      const area = byId('cfgToppings'); area.innerHTML='';
      byId('topPriceLabel').textContent = euro(CATALOG.toppingPrice);
      CATALOG.toppings.forEach((name,i)=>{
        const id = 'cfg_top_'+i;
        const label = document.createElement('label');
        label.className='chip';
        label.innerHTML = `<input type="checkbox" value="${name}" id="${id}"> ${name}`;
        area.appendChild(label);
        label.querySelector('input').addEventListener('change', ()=>{
          const set = new Set(cfg.toppings);
          if(label.querySelector('input').checked) set.add(name); else set.delete(name);
          cfg.toppings = [...set];
          updateCfgPrice();
        });
      });
      byId('configModal').classList.add('open');
      updateCfgPrice();
    }
    function updateCfgPrice(){
      const p = CATALOG.pizzas.find(x=>x.id===cfg.pizzaId); if(!p) return;
      const base = p.base[cfg.size] || 0;
      const price = (base + cfg.toppings.length * (CATALOG.toppingPrice||0)) * cfg.qty;
      byId('cfgPrice').textContent = `Prix: ${euro(price)}`;
    }

    /* ===== Panier ===== */
    function renderOrderTable(){
      const tb = byId('orderTable').querySelector('tbody'); tb.innerHTML='';
      let total = 0;
      currentItems.forEach(line=>{
        const lineTotal = line.unitPrice * line.qty; total += lineTotal;
        const tr = document.createElement('tr');
        const tops = (line.toppings && line.toppings.length) ? ' + ' + line.toppings.join(', ') : '';
        const note = line.note && line.note.trim()
          ? `<div class="help" style="margin-top:2px"><em>Note&nbsp;:</em> ${line.note}</div>`
          : '';
        tr.innerHTML = `
          <td>${line.name}${line.size ? ' ('+line.size+')' : ''}${tops}${note}<div class="help">${euro(line.unitPrice)} / unit√©</div></td>
          <td>
            <div style="display:flex; gap:6px; align-items:center">
              <button class="icon-btn" title="Moins" aria-label="Moins" onclick="decItem('${line.id}')">‚àí</button>
              <span aria-live="polite">${line.qty}</span>
              <button class="icon-btn" title="Plus" aria-label="Plus" onclick="incItem('${line.id}')">+</button>
            </div>
          </td>
          <td>${euro(lineTotal)}</td>
          <td>
            <button class="icon-btn" title="Dupliquer" aria-label="Dupliquer" onclick="dupItem('${line.id}')">‚éò</button>
            <button class="icon-btn" title="Supprimer" aria-label="Supprimer" onclick="removeItem('${line.id}')">‚úï</button>
          </td>`;
        tb.appendChild(tr);
      });
      byId('grandTotal').textContent = euro(total);
      saveCart();
      updateSlotsCapacity();
    }
    function removeItem(id){ currentItems = currentItems.filter(l=>l.id!==id); renderOrderTable(); }
    function incItem(id){ const it=currentItems.find(l=>l.id===id); if(!it) return; it.qty+=1; renderOrderTable(); }
    function decItem(id){ const it=currentItems.find(l=>l.id===id); if(!it) return; it.qty-=1; if(it.qty<=0){ removeItem(id); } else { renderOrderTable(); } }
    function dupItem(id){ const it=currentItems.find(l=>l.id===id); if(!it) return; const copy={...structuredClone(it), id: crypto.randomUUID()}; currentItems.push(copy); renderOrderTable(); }

    function resetOrder(){
      currentItems=[];
      byId('client').value='';
      byId('phone').value='';
      byId('slot').value='';
      renderOrderTable();
      saveCart();
      editingOrderId = null;
      const btn = byId('saveOrder');
      if(btn){ btn.textContent = 'Enregistrer la commande'; }
      updateFieldHints();
    }

    /* ===== Indices visuels ===== */
    function updateFieldHints(){
      const clientEl = byId('client');
      const slotEl = byId('slot');
      const phoneEl = byId('phone');
      if(!clientEl || !slotEl || !phoneEl) return;
      const clientEmpty = clientEl.value.trim().length === 0;
      const slotEmpty   = slotEl.value.trim().length === 0;
      const phoneEmpty  = phoneEl.value.trim().length === 0;
      clientEl.classList.toggle('input-invalid', clientEmpty);
      slotEl.classList.toggle('input-invalid',   slotEmpty);
      phoneEl.classList.toggle('input-invalid',  phoneEmpty);
    }

    /* ===== Auto-compl√©tion client / t√©l√©phone ===== */
    function handleClientChange(){
      const nameInput = byId('client');
      const phoneInput = byId('phone');
      const sel = byId('nameSuggestions');
      const name = nameInput.value.trim();

      if(!name){
        if(sel) sel.style.display='none';
        phoneInput.value = '';
        updateFieldHints();
        return;
      }

      const norm = normalizeName(name);
      const matches = clients.filter(c => normalizeName(c.name).startsWith(norm));

      if(matches.length === 1){
        phoneInput.value = matches[0].phone || '';
        if(sel) sel.style.display='none';
      } else if(matches.length > 1){
        if(!sel) return;
        sel.innerHTML = '<option value="">S√©lectionner un client‚Ä¶</option>';
        matches.forEach((c,i)=>{
          const opt = document.createElement('option');
          opt.value = String(i);
          opt.textContent = `${c.name} ‚Ä¢ ${c.phone} (${c.count||1} cmd)`;
          sel.appendChild(opt);
        });
        sel.style.display='inline-block';
        sel.onchange = ()=>{
          const idx = parseInt(sel.value,10);
          if(!isNaN(idx) && matches[idx]){
            const c = matches[idx];
            nameInput.value = c.name;
            phoneInput.value = c.phone;
            sel.style.display='none';
            updateFieldHints();
          }
        };
      } else {
        if(sel) sel.style.display='none';
        phoneInput.value = '';
      }

      updateFieldHints();
    }

    function handlePhoneChange(){
      const nameInput = byId('client');
      const phoneInput = byId('phone');
      const sel = byId('phoneSuggestions');
      const phone = phoneInput.value;
      const norm = normalizePhone(phone);
      if(!norm){
        if(sel) sel.style.display='none';
        updateFieldHints();
        return;
      }
      const matches = clients.filter(c => normalizePhone(c.phone).startsWith(norm));

      if(matches.length === 1){
        const c = matches[0];
        const currentName = nameInput.value.trim();
        if(!currentName || normalizeName(currentName) === normalizeName(c.name)){
          nameInput.value = c.name;
        }
        if(sel) sel.style.display='none';
      } else if(matches.length > 1){
        if(!sel) return;
        sel.innerHTML = '<option value="">S√©lectionner un num√©ro‚Ä¶</option>';
        matches.forEach((c,i)=>{
          const opt = document.createElement('option');
          opt.value = String(i);
          opt.textContent = `${c.phone} ‚Ä¢ ${c.name} (${c.count||1} cmd)`;
          sel.appendChild(opt);
        });
        sel.style.display='inline-block';
        sel.onchange = ()=>{
          const idx = parseInt(sel.value,10);
          if(!isNaN(idx) && matches[idx]){
            const c = matches[idx];
            phoneInput.value = c.phone;
            nameInput.value = c.name;
            sel.style.display='none';
            updateFieldHints();
          }
        };
      } else {
        if(sel) sel.style.display='none';
      }
      updateFieldHints();
    }

    /* ===== Enregistrement commande ===== */
    function saveOrder(){
      const clientEl = byId('client');
      const slotEl = byId('slot');
      const phoneEl = byId('phone');

      const clientOk = clientEl.value.trim().length > 0;
      const slotOk = slotEl.value.trim().length > 0;
      const phoneOk = phoneEl.value.trim().length > 0;
      const hasItems = currentItems.length > 0;

      if(!(clientOk && slotOk && phoneOk && hasItems)){
        [clientOk ? null : clientEl,
         slotOk   ? null : slotEl,
         phoneOk  ? null : phoneEl].filter(Boolean).forEach(el=>{
          el.classList.add('shake'); setTimeout(()=>el.classList.remove('shake'), 300);
        });
        const missing = [];
        if(!clientOk) missing.push('nom du client');
        if(!phoneOk)  missing.push('num√©ro de t√©l√©phone');
        if(!slotOk)   missing.push('cr√©neau');
        if(!hasItems) missing.push('au moins 1 article');
        updateFieldHints();
        showHealth('Compl√©tez : ' + missing.join(', '), 'error', 2500);
        return;
      }

      const slot = slotEl.value;
      const booked = pizzasBookedForSlot(slot, editingOrderId || undefined);
      const inCart = pizzasInCart();
      if(!unlockSlots && (booked + inCart > SLOT_CAP)){
        const remaining = Math.max(0, SLOT_CAP - booked);
        alert(`Cr√©neau ${slot} complet ou insuffisant : ${booked}/${SLOT_CAP} pizzas d√©j√† r√©serv√©es. Il reste ${remaining} place(s) pour des pizzas.`);
        return;
      }

      const clientName = clientEl.value.trim();
      const phone = (phoneEl.value || '').trim();
      const total = currentItems.reduce((s,l)=> s + l.unitPrice*l.qty, 0);

      rememberClient(clientName, phone);

      if(editingOrderId){
        const idx = savedOrders.findIndex(o=>o.id===editingOrderId);
        if(idx !== -1){
          const old = savedOrders[idx];
          savedOrders[idx] = {
            ...old,
            client: clientName,
            phone,
            slot,
            status: old.status || 'pr√©paration',
            items: structuredClone(currentItems),
            total,
            updatedAt: new Date().toISOString()
          };
          saveOrders(); renderSavedOrders(); updateSlotsCapacity();
          showHealth('Commande mise √† jour ‚úÖ', 'ok', 2000);
        }
        resetOrder();
        return;
      }

      const ticket = nextTicket();
      const order = {
        id: crypto.randomUUID(),
        at: new Date().toISOString(),
        client: clientName,
        phone,
        type: '√† emporter',
        slot,
        status: 'pr√©paration',
        ticket,
        items: structuredClone(currentItems),
        total
      };
      savedOrders.unshift(order);
      saveOrders(); renderSavedOrders(); updateSlotsCapacity();
      resetOrder();
    }

    function startEdit(id){
      const o = savedOrders.find(x=>x.id===id);
      if(!o) return;
      currentItems = structuredClone(o.items || []);
      byId('client').value = o.client || '';
      byId('phone').value = o.phone || '';
      byId('slot').value = o.slot || '';
      renderOrderTable();
      editingOrderId = id;
      const btn = byId('saveOrder');
      if(btn){ btn.textContent = 'Mettre √† jour la commande'; }
      showHealth(`Mode √©dition : ${o.ticket ? o.ticket+' ‚Ä¢ ' : ''}${o.client}`, 'ok', 2000);
      updateFieldHints();
    }

    /* ===== Post-it / Archive ===== */
    const _drinkNames = ()=> new Set((CATALOG.drinks||[]).map(d=>d.name));
    const _dessertNames = ()=> new Set((CATALOG.desserts||[]).map(d=>d.name));
    function lineKind(line){
      if(line.kind) return line.kind;
      if(line.pizzaId) return 'pizza';
      const dn=_drinkNames(), sn=_dessertNames();
      if(dn.has(line.name)) return 'drink';
      if(sn.has(line.name)) return 'dessert';
      return 'other';
    }
    function formatLineHTML(line){
      const base = `${line.qty}√ó ${line.name}${line.size ? ' ('+line.size+')' : ''}`;
      const supp = (line.toppings && line.toppings.length)
        ? `<div class="help" style="margin-top:2px">Supp: ${line.toppings.join(', ')}</div>`
        : '';
      const note = line.note && line.note.trim()
        ? `<div class="help" style="margin-top:2px"><em>Note&nbsp;:</em> ${line.note}</div>`
        : '';
      return `${base}${supp}${note}`;
    }

    function renderSavedOrders(){
      const area = byId('savedOrders'); 
      area.innerHTML='';

      const filterSel = byId('filterSlot');
      let filter = '';
      if (filterSel) {
        const previous = filterSel.value;
        const slots = [...new Set(savedOrders.map(o=>o.slot).filter(Boolean))].sort();

        filterSel.innerHTML = '<option value="">Tous les cr√©neaux</option>';
        slots.forEach(s=>{
          const opt = document.createElement('option');
          opt.value = s;
          opt.textContent = s;
          filterSel.appendChild(opt);
        });

        filterSel.value = previous || '';
        filter = filterSel.value;
      }

      const slotMinutes = (s)=>{
        if(!s || !/^\d{2}:\d{2}$/.test(s)) return 99999;
        const [h,m] = s.split(':').map(Number);
        return h*60 + m;
      };

      const list = savedOrders
        .filter(o => !filter || o.slot === filter)
        .slice()
        .sort((a,b)=>{
          const d = slotMinutes(a.slot) - slotMinutes(b.slot);
          if (d !== 0) return d;
          return new Date(a.at) - new Date(b.at);
        });

      if(list.length===0){
        const d=document.createElement('div'); 
        d.className='help'; 
        d.style.whiteSpace='nowrap'; 
        d.textContent='Aucune commande enregistr√©e.'; 
        area.appendChild(d); 
        return;
      }

      list.forEach(o=>{
        const note = document.createElement('article'); note.className='order-note';

        const groups = { pizza:[], drink:[], dessert:[], other:[] };
        (o.items||[]).forEach(i => groups[lineKind(i)].push(i));
        function section(label, arr){
          if(!arr.length) return '';
          return `<div style="margin-top:4px"><strong>${label}</strong><br>${arr.map(formatLineHTML).join('<br>')}</div>`;
        }
        const itemsText =
          section('üçï Pizzas', groups.pizza) +
          section('ü•§ Boissons', groups.drink) +
          section('üç∞ Desserts', groups.dessert) +
          section('Autres', groups.other);

        const pizzasCount = countPizzasIn(o.items||[]);

        note.innerHTML = `
          <div class="note-actions">
            <button class="icon-btn" title="Modifier" onclick="startEdit('${o.id}')">‚úèÔ∏è</button>
            <button class="icon-btn" title="Imprimer" onclick="printSavedOrder('${o.id}')">üñ®Ô∏è</button>
            <button class="icon-btn" title="Supprimer" onclick="deleteOrder('${o.id}')">üóëÔ∏è</button>
          </div>
          <header><span class="badge" data-status="${o.status}">${o.status}</span></header>
          <h4>${o.ticket ? o.ticket + ' ‚Ä¢ ' : ''}${(o.client || '').toUpperCase()}</h4>
          <p class="help">
            ${new Date(o.at).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}
            ‚Ä¢ ${o.type}
            ‚Ä¢ ${o.slot||'‚Äî'}
            ‚Ä¢ <span style="white-space:nowrap">üçï ${pizzasCount} pizza${pizzasCount>1?'s':''}</span>
            ${o.phone ? ' ‚Ä¢ üìû ' + o.phone : ''}
          </p>
          <div>${itemsText || ''}</div>
          <p style="font-weight:800; margin-top:6px">${euro(o.total)}</p>
          <div style="display:flex; gap:6px; margin-top:8px">
            <button class="icon-btn" title="Marquer livr√©e" onclick="confirmDeliver('${o.id}')">‚úÖ</button>
          </div>`;
        area.appendChild(note);
      });
    }

    function deleteOrder(id){
      if(!confirm('Supprimer cette commande ?')) return;
      savedOrders = savedOrders.filter(o=>o.id!==id);
      saveOrders();
      renderSavedOrders();
      updateSlotsCapacity();
    }

    /* ===== Impression ticket ===== */
    function printOrder(order){
      const w = window.open('', '_blank');
      const style = `
        @page{ size: 80mm auto; margin: 4mm }
        *{ -webkit-print-color-adjust: exact; print-color-adjust: exact }
        body{ font:14px/1.35 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; width:80mm; margin:0; padding:0 }
        h1{ font-size:16px; margin:0 0 8px }
        .muted{ opacity:.75 }
        ul{ list-style:none; padding:0; margin:8px 0 }
        li{ margin:4px 0; display:flex; justify-content:space-between; gap:8px }
        .tot{ margin-top:8px; font-weight:700; border-top:1px dashed #999; padding-top:6px }
      `;
      const items = order.items.map(i=>{
        const size = i.size ? ' ('+i.size+')' : '';
        const tops = (i.toppings && i.toppings.length) ? ' + ' + i.toppings.join(', ') : '';
        const note = i.note && i.note.trim() ? ` ‚Äî Note: ${i.note}` : '';
        return `<li><span>${i.qty}√ó ${i.name}${size}${tops}${note}</span><span>${euro(i.unitPrice * i.qty)}</span></li>`;
      }).join('');
      const phoneLine = order.phone ? `<div class="muted">T√©l&nbsp;: ${order.phone}</div>` : '';
      const html = `<!doctype html><html><head><meta charset="utf-8"><title>${order.ticket || 'Ticket'}</title><style>${style}</style></head><body>
        <h1>Ticket ${order.ticket ? order.ticket + ' ‚Äì ' : ''}${order.client}</h1>
        <div class="muted">${new Date(order.at).toLocaleString('fr-FR')} ‚Ä¢ ${order.type} ‚Ä¢ ${order.slot}</div>
        ${phoneLine}
        <ul>${items}</ul>
        <div class="tot">Total: ${euro(order.total)}</div>
      </body></html>`;
      w.document.open(); w.document.write(html); w.document.close(); w.focus(); w.print();
    }
    function printSavedOrder(id){ const o = savedOrders.find(x=>x.id===id); if(o) printOrder(o); }

    /* ===== Archivage ===== */
    function confirmDeliver(id){
      const o = savedOrders.find(x=>x.id===id);
      if(!o) return;
      if(!confirm('Marquer cette commande comme livr√©e et l‚Äôarchiver ?')) return;
      o.status = 'livr√©e';
      savedOrders = savedOrders.filter(x=>x.id!==id);
      saveOrders();
      archivedOrders.unshift({ ...o, archivedAt: new Date().toISOString() });
      saveArchived();
      renderSavedOrders();
      updateSlotsCapacity();
    }
    function restoreOrder(id){
      const idx = archivedOrders.findIndex(o => o.id === id);
      if(idx === -1) return;
      if(!confirm('Restaurer cette commande dans les post-it ?')) return;
      const o = archivedOrders[idx];
      archivedOrders.splice(idx, 1);
      saveArchived();
      const restored = { ...o, status: 'pr√©paration', restoredAt: new Date().toISOString() };
      savedOrders.unshift(restored);
      saveOrders();
      const s = byId('archiveStart')?.value || '';
      const e = byId('archiveEnd')?.value || '';
      renderArchive(s, e);
      updateSlotsCapacity();
    }

    function sameDayISO(ts){ const d=new Date(ts); return d.toISOString().slice(0,10); }
    function todayISO(){ return new Date().toISOString().slice(0,10); }

    function deleteArchiveItem(id){
      const o = archivedOrders.find(x => x.id === id);
      if (!o) return;

      if (!confirm('Supprimer d√©finitivement cette commande livr√©e ?')) return;

      archivedOrders = archivedOrders.filter(x => x.id !== id);
      saveArchived();

      const s = byId('archiveStart')?.value || '';
      const e = byId('archiveEnd')?.value || '';
      renderArchive(s, e);

      showHealth('Commande supprim√©e de l‚Äôhistorique.', 'ok', 2000);
    }

    function renderArchive(startDay, endDay){
      const area = byId('archiveContent');
      const countLabel = byId('archiveCount');
      area.innerHTML = '';

      // Filtrage sur la p√©riode
      let filtered = archivedOrders.slice();
      if (startDay || endDay) {
        filtered = filtered.filter(o => {
          const day = sameDayISO(o.archivedAt || o.at || Date.now());
          if (startDay && day < startDay) return false;
          if (endDay && day > endDay) return false;
          return true;
        });
      }

      // MODE JOURNALIER REGROUP√â
      if (archiveViewMode === 'daily') {
        const byDay = new Map();

        filtered.forEach(o=>{
          const day = sameDayISO(o.archivedAt || o.at);
          let entry = byDay.get(day);
          if (!entry){
            entry = { day, orders:0, total:0, pizzas:0 };
            byDay.set(day, entry);
          }
          entry.orders += 1;
          entry.total  += o.total || 0;
          entry.pizzas += countPizzasIn(o.items || []);
        });

        const rowsArr = [...byDay.values()].sort((a,b)=> a.day.localeCompare(b.day));

        if (countLabel){
          countLabel.textContent = `${rowsArr.length} jour(s) dans la p√©riode`;
        }

        if (!rowsArr.length){
          area.innerHTML = '<p class="help">Aucune commande livr√©e dans cette p√©riode.</p>';
          return;
        }

        const wrapper = document.createElement('div');
        wrapper.className = 'card';
        wrapper.style.boxShadow = 'none';
        wrapper.innerHTML = `
          <div class="body" style="padding:0">
            <table>
              <thead>
                <tr>
                  <th>Jour</th>
                  <th style="text-align:right">Commandes</th>
                  <th style="text-align:right">Pizzas</th>
                  <th style="text-align:right">Total</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>`;
        const tbody = wrapper.querySelector('tbody');

        rowsArr.forEach(r=>{
          const d = new Date(r.day + 'T00:00:00');
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${d.toLocaleDateString('fr-FR')}</td>
            <td style="text-align:right">${r.orders}</td>
            <td style="text-align:right">${r.pizzas}</td>
            <td style="text-align:right">${euro(r.total)}</td>`;
          tbody.appendChild(tr);
        });

        area.appendChild(wrapper);
        return;
      }

      // MODE D√âTAIL
      if (countLabel) {
        countLabel.textContent = `${filtered.length} commande(s) dans la p√©riode`;
      }

      if (!filtered.length) {
        area.innerHTML = '<p class="help">Aucune commande livr√©e pour cette s√©lection.</p>';
        return;
      }

      const list = filtered.slice().sort((a,b)=> new Date(a.at) - new Date(b.at));

      const wrapper = document.createElement('div');
      wrapper.className = 'card';
      wrapper.style.boxShadow = 'none';
      wrapper.innerHTML = `
        <div class="body" style="padding:0">
          <table>
            <thead>
              <tr>
                <th>Ticket</th>
                <th>Date/Heure</th>
                <th>Client</th>
                <th>Cr√©neau</th>
                <th style="text-align:right">Total</th>
                <th style="width:1%"></th>
                <th style="width:1%"></th>
                <th style="width:1%"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>`;
      const tbody = wrapper.querySelector('tbody');

      list.forEach(o=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${o.ticket||''}</td>
          <td>${new Date(o.at).toLocaleString('fr-FR')}</td>
          <td>${o.client}</td>
          <td>${o.slot}</td>
          <td style="text-align:right">${euro(o.total||0)}</td>
          <td><button class="icon-btn" title="Imprimer">üñ®Ô∏è</button></td>
          <td><button class="icon-btn" title="Restaurer">üîÑ</button></td>
          ${archiveDeleteMode
            ? `<td><button class="icon-btn" title="Supprimer d√©finitivement">üóëÔ∏è</button></td>`
            : `<td></td>`}
        `;
        const btns = tr.querySelectorAll('button');
        const printBtn = btns[0];
        const restoreBtn = btns[1];
        printBtn.addEventListener('click', ()=> printOrder(o));
        restoreBtn.addEventListener('click', ()=> restoreOrder(o.id));

        if (archiveDeleteMode && btns[2]) {
          const delBtn = btns[2];
          delBtn.addEventListener('click', ()=> deleteArchiveItem(o.id));
        }

        tbody.appendChild(tr);
      });

      area.appendChild(wrapper);
    }

    function openArchive(){
      const startInput = byId('archiveStart');
      const endInput   = byId('archiveEnd');
      const today      = todayISO();

      if (startInput && endInput) {
        if (!startInput.value) startInput.value = today;
        if (!endInput.value)   endInput.value   = today;

        const refresh = () => {
          renderArchive(startInput.value || '', endInput.value || '');
        };

        startInput.onchange = refresh;
        endInput.onchange   = refresh;
      }

      const btnToday = byId('archiveToday');
      if (btnToday && startInput && endInput) {
        btnToday.onclick = () => {
          const t = todayISO();
          startInput.value = t;
          endInput.value   = t;
          renderArchive(t, t);
        };
      }

      const btnMonth = byId('archiveThisMonth');
      if (btnMonth && startInput && endInput) {
        btnMonth.onclick = () => {
          const d     = new Date();
          const year  = d.getFullYear();
          const month = d.getMonth(); // 0‚Äì11
          const first = new Date(year, month, 1);
          const last  = new Date(year, month + 1, 0);
          const toISO = (dd) => dd.toISOString().slice(0, 10);
          const s = toISO(first);
          const e = toISO(last);
          startInput.value = s;
          endInput.value   = e;
          renderArchive(s, e);
        };
      }

      const clearBtn = byId('clearArchive');
      if (clearBtn) {
        clearBtn.style.display = archiveDeleteMode ? 'inline-flex' : 'none';
      }

      const initStart = startInput?.value || today;
      const initEnd   = endInput?.value   || today;
      renderArchive(initStart, initEnd);

      if (typeof syncArchiveViewTabs === 'function') {
        syncArchiveViewTabs();
      }

      byId('archiveModal').classList.add('open');
    }

    function clearArchive(){
      if (!archivedOrders.length) { alert('Historique d√©j√† vide.'); return; }
      if (!confirm('Supprimer d√©finitivement toutes les commandes livr√©es de l‚Äôhistorique ?')) return;
      if (!confirm('Confirmer encore : cette action est irr√©versible.')) return;
      archivedOrders = [];
      saveArchived();
      const s = byId('archiveStart')?.value || '';
      const e = byId('archiveEnd')?.value || '';
      renderArchive(s, e);
      showHealth('Historique vid√©.', 'ok', 2000);
    }

    function exportArchiveCSV(){
      if (!archivedOrders || !archivedOrders.length){
        alert("Aucune commande livr√©e √† exporter.");
        return;
      }
      const start = byId('archiveStart')?.value || '';
      const end   = byId('archiveEnd')?.value   || '';

      let filtered = archivedOrders.slice();
      if (start || end) {
        filtered = filtered.filter(o => {
          const day = sameDayISO(o.archivedAt || o.at || Date.now());
          if (start && day < start) return false;
          if (end && day > end) return false;
          return true;
        });
      }

      if (!filtered.length){
        alert("Aucune commande dans cette p√©riode.");
        return;
      }

      filtered.sort((a,b)=> new Date(a.at) - new Date(b.at));

      const rows = [[
        'date_commande',
        'ticket',
        'client',
        'creneau',
        'total_commande'
      ]];

      let totalDay = 0;

      filtered.forEach(o => {
        const dateCmd = new Date(o.at || Date.now());
        const tot = Number(o.total || 0);
        totalDay += tot;

        rows.push([
          dateCmd.toLocaleString('fr-FR'),
          o.ticket || '',
          o.client || '',
          o.slot || '',
          String(tot).replace('.', ',')
        ]);
      });

      rows.push([]);
      rows.push(['', '', '', 'Total periode', String(totalDay).replace('.', ',')]);

      const csv = rowsToCSV(rows);
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csv], { type:'text/csv;charset=utf-8;' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      const label = (start || end) ? `${start || ''}_au_${end || ''}` : todayISO();
      a.href = url;
      a.download = `historique_${label}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    /* ===== Fichier clients ‚Äì affichage Admin / export ===== */
    function renderClientsAdmin(){
      const area = byId('clientsAdmin');
      if(!area) return;
      if(!clients.length){
        area.innerHTML = '<p class="help">Aucun client enregistr√© pour le moment.</p>';
        return;
      }
      const sorted = clients.slice().sort((a,b)=>{
        const ca = a.count||0, cb=b.count||0;
        if(cb!==ca) return cb-ca;
        return (b.lastOrderAt||'').localeCompare(a.lastOrderAt||'');
      });

      const rows = sorted.map(c=>{
        const last = c.lastOrderAt ? new Date(c.lastOrderAt).toLocaleString('fr-FR') : '‚Äî';
        return `<tr>
          <td>${c.name}</td>
          <td>${c.phone}</td>
          <td style="text-align:right">${c.count||1}</td>
          <td>${last}</td>
        </tr>`;
      }).join('');
      area.innerHTML = `
        <div class="card" style="box-shadow:none;">
          <div class="body" style="padding:0">
            <table>
              <thead>
                <tr>
                  <th>Nom</th>
                  <th>T√©l√©phone</th>
                  <th style="text-align:right">Commandes</th>
                  <th>Derni√®re commande</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        </div>`;
    }

    function exportClients(){
      if(!clients.length){
        alert('Aucun client √† exporter.');
        return;
      }
      const rows = [['nom','telephone','commandes','date_creation','derniere_commande']];
      clients.forEach(c=>{
        rows.push([
          c.name||'',
          c.phone||'',
          String(c.count||1),
          c.createdAt||'',
          c.lastOrderAt||''
        ]);
      });
      const csv = rowsToCSV(rows);
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a');
      a.href = url; a.download = `clients_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url);
    }

    function clearClients(){
      if(!clients.length){
        alert('Fichier clients d√©j√† vide.');
        return;
      }
      if(!confirm('Vider compl√®tement le fichier clients ?')) return;
      if(!confirm('Confirmer encore : cette action est irr√©versible.')) return;
      clients = [];
      saveClients();
      renderClientsAdmin();
      showHealth('Fichier clients vid√©.', 'ok', 2000);
    }

    /* ===== Stats ‚Äì helpers ===== */
    function getOrdersForStatsRange(){
      const start = byId('statsStart')?.value || '';
      const end   = byId('statsEnd')?.value   || '';
      const orders = [...savedOrders, ...archivedOrders].filter(o => {
        const d = sameDayISO(o.at);
        if (start && d < start) return false;
        if (end   && d > end)   return false;
        return true;
      });
      return { start, end, orders };
    }

    /* ===== Stats ===== */
    function computeStatsForRange(startDay, endDay){
      const allOrders = [...savedOrders, ...archivedOrders].filter(o => {
        const d = sameDayISO(o.at);
        if (startDay && d < startDay) return false;
        if (endDay && d > endDay) return false;
        return true;
      });

      const totalSales    = allOrders.reduce((s,o)=> s + (o.total||0), 0);
      const totalPizzas   = allOrders.reduce((s,o)=> s + countPizzasIn(o.items||[]), 0);
      const totalDrinks   = allOrders.reduce((s,o)=> s + countDrinksIn(o.items||[]), 0);
      const totalDesserts = allOrders.reduce((s,o)=> s + countDessertsIn(o.items||[]), 0);
      const ordersCount   = allOrders.length;

      const perSlotMap = new Map();
      allOrders.forEach(o => {
        const slot     = o.slot || '‚Äî';
        const pizzas   = countPizzasIn(o.items || []);
        const drinks   = countDrinksIn(o.items || []);
        const desserts = countDessertsIn(o.items || []);
        const prev     = perSlotMap.get(slot) || { orders:0, pizzas:0, drinks:0, desserts:0, total:0 };

        prev.orders   += 1;
        prev.pizzas   += pizzas;
        prev.drinks   += drinks;
        prev.desserts += desserts;
        prev.total    += (o.total || 0);

        perSlotMap.set(slot, prev);
      });
      const perSlot = [...perSlotMap.entries()]
        .sort(([a],[b]) => a.localeCompare(b));

      const perDayMap = new Map();
      allOrders.forEach(o => {
        const d        = sameDayISO(o.at);
        const pizzas   = countPizzasIn(o.items || []);
        const drinks   = countDrinksIn(o.items || []);
        const desserts = countDessertsIn(o.items || []);
        const prev     = perDayMap.get(d) || { orders:0, pizzas:0, drinks:0, desserts:0, total:0 };

        prev.orders   += 1;
        prev.pizzas   += pizzas;
        prev.drinks   += drinks;
        prev.desserts += desserts;
        prev.total    += (o.total || 0);

        perDayMap.set(d, prev);
      });
      const perDay = [...perDayMap.entries()].sort(([a],[b]) => a.localeCompare(b));

      return { 
        ordersCount, 
        totalSales, 
        totalPizzas, 
        totalDrinks, 
        totalDesserts,
        perSlot, 
        perDay 
      };
    }

    function renderStatsForRange(startDay, endDay){
      const s = computeStatsForRange(startDay, endDay);

      const periodLabel = (startDay || endDay)
        ? `<p class="help">P√©riode : ${startDay || '‚Ä¶'} ‚Üí ${endDay || '‚Ä¶'}</p>`
        : '';

      const cards = `
        ${periodLabel}
        <div class="stats-cards">
          <div class="stats-card"><h4>Commandes</h4><div class="v">${s.ordersCount}</div></div>
          <div class="stats-card"><h4>Pizzas</h4><div class="v">${s.totalPizzas}</div></div>
          <div class="stats-card"><h4>Total ventes</h4><div class="v">${euro(s.totalSales)}</div></div>
        </div>
        <div class="stats-cards">
          <div class="stats-card"><h4>Boissons</h4><div class="v">${s.totalDrinks}</div></div>
          <div class="stats-card"><h4>Desserts</h4><div class="v">${s.totalDesserts}</div></div>
        </div>`;

      let table = '';
      if (s.perSlot.length){
        const max = Math.max(1, ...s.perSlot.map(([,v]) => v.pizzas));
        const rows = s.perSlot.map(([slot, stats]) => {
          const n   = stats.pizzas;
          const pct = Math.round((n / max) * 100);
          return `<tr>
            <td>${slot}</td>
            <td><div class="bar"><span style="width:${pct}%"></span></div></td>
            <td style="text-align:right">${n}</td>
          </tr>`;
        }).join('');
        table = `
          <div class="stats-table">
            <table>
              <thead>
                <tr>
                  <th>Cr√©neau</th>
                  <th style="width:60%">R√©partition</th>
                  <th style="text-align:right">Pizzas</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      } else {
        table = '<p class="help">Aucune commande pour cette p√©riode.</p>';
      }

      byId('statsContent').innerHTML = cards + table;
    }

    function openStats(){
      const startInput = byId('statsStart');
      const endInput   = byId('statsEnd');
      const today      = todayISO();

      if (startInput && endInput) {
        if (!startInput.value) startInput.value = today;
        if (!endInput.value)   endInput.value   = today;

        const refresh = () => {
          renderStatsForRange(startInput.value || '', endInput.value || '');
        };

        startInput.onchange = refresh;
        endInput.onchange   = refresh;
      }

      const btnToday = byId('statsToday');
      if (btnToday && startInput && endInput) {
        btnToday.onclick = () => {
          const t = todayISO();
          startInput.value = t;
          endInput.value   = t;
          renderStatsForRange(t, t);
        };
      }

      const btnMonth = byId('statsThisMonth');
      if (btnMonth && startInput && endInput) {
        btnMonth.onclick = () => {
          const d     = new Date();
          const year  = d.getFullYear();
          const month = d.getMonth(); // 0‚Äì11
          const first = new Date(year, month, 1);
          const last  = new Date(year, month + 1, 0);
          const toISO = (dd) => dd.toISOString().slice(0, 10);
          const s = toISO(first);
          const e = toISO(last);
          startInput.value = s;
          endInput.value   = e;
          renderStatsForRange(s, e);
        };
      }

      const initStart = startInput?.value || today;
      const initEnd   = endInput?.value   || today;
      renderStatsForRange(initStart, initEnd);

      byId('statsModal').classList.add('open');
    }

    /* ===== Exports Stats ===== */
    function exportStatsCSV(){
      const { start, end, orders } = getOrdersForStatsRange();
      if (!orders.length){
        alert('Aucune commande dans cette p√©riode.');
        return;
      }

      const perSlotMap = new Map();
      orders.forEach(o=>{
        const slot = o.slot || '‚Äî';
        const pizzas   = countPizzasIn(o.items||[]);
        const drinks   = countDrinksIn(o.items||[]);
        const desserts = countDessertsIn(o.items||[]);
        const prev = perSlotMap.get(slot) || {orders:0,pizzas:0,drinks:0,desserts:0,total:0};
        prev.orders += 1;
        prev.pizzas += pizzas;
        prev.drinks += drinks;
        prev.desserts += desserts;
        prev.total  += (o.total||0);
        perSlotMap.set(slot, prev);
      });
      const list = [...perSlotMap.entries()].sort(([a],[b])=>a.localeCompare(b));

      const rows = [[
        'creneau',
        'commandes',
        'pizzas',
        'boissons',
        'desserts',
        'total_ventes'
      ]];

      let totalCmd=0, totalPiz=0, totalDrk=0, totalDes=0, totalVte=0;
      list.forEach(([slot,st])=>{
        rows.push([
          slot,
          String(st.orders),
          String(st.pizzas),
          String(st.drinks),
          String(st.desserts),
          String(st.total).replace('.',',')
        ]);
        totalCmd += st.orders;
        totalPiz += st.pizzas;
        totalDrk += st.drinks;
        totalDes += st.desserts;
        totalVte += st.total;
      });
      rows.push([]);
      rows.push([
        'Total periode',
        String(totalCmd),
        String(totalPiz),
        String(totalDrk),
        String(totalDes),
        String(totalVte).replace('.',',')
      ]);

      const csv  = rowsToCSV(rows);
      const html = rowsToHTMLTable(rows);
      const label = (start || end) ? `${start || ''} ‚Üí ${end || ''}` : todayISO();
      openExportPreview({
        title: `Stats par cr√©neau (${label})`,
        html,
        csv
      });
    }

    function exportDrinksDessertsCSV(){
      const { start, end, orders } = getOrdersForStatsRange();

      if (!orders.length){
        alert('Aucune commande dans cette p√©riode.');
        return;
      }

      const map = new Map();
      orders.forEach(o => {
        (o.items || []).forEach(line => {
          const kind = lineKind(line);
          if (kind !== 'drink' && kind !== 'dessert') return;

          const name = line.name || '???';
          const qty  = Number(line.qty || 0);
          const unit = Number(line.unitPrice || 0);
          const totalLine = qty * unit;

          const key = kind + ':' + name;
          const prev = map.get(key) || { kind, name, qty:0, total:0 };
          prev.qty   += qty;
          prev.total += totalLine;
          map.set(key, prev);
        });
      });

      if (!map.size){
        alert('Aucune boisson ni dessert dans cette p√©riode.');
        return;
      }

      const rowsData = [...map.values()].sort((a,b) => {
        if (a.kind !== b.kind) return a.kind.localeCompare(b.kind);
        return b.qty - a.qty;
      });

      const rows = [[
        'type',
        'nom',
        'quantite',
        'total_ventes'
      ]];

      let totalQty=0, totalSales=0;

      rowsData.forEach(r => {
        const typeLabel = (r.kind === 'drink') ? 'boisson' : 'dessert';
        rows.push([
          typeLabel,
          r.name,
          String(r.qty),
          String(r.total).replace('.', ',')
        ]);
        totalQty   += r.qty;
        totalSales += r.total;
      });

      rows.push([]);
      rows.push([
        'Total periode',
        '',
        String(totalQty),
        String(totalSales).replace('.', ',')
      ]);

      const csv  = rowsToCSV(rows);
      const html = rowsToHTMLTable(rows);
      const label = (start || end) ? `${start || ''} ‚Üí ${end || ''}` : todayISO();
      openExportPreview({
        title: `Boissons & desserts (${label})`,
        html,
        csv
      });
    }

    function exportDailyTypesCSV(){
      const { start, end, orders } = getOrdersForStatsRange();

      if (!orders.length){
        alert('Aucune commande dans cette p√©riode.');
        return;
      }

      const perDayType = new Map();

      orders.forEach(o => {
        const day = sameDayISO(o.at);
        let bucket = perDayType.get(day);
        if (!bucket){
          bucket = {};
          perDayType.set(day, bucket);
        }

        (o.items || []).forEach(line => {
          const kind = lineKind(line) || 'other';
          const name = line.name || '???';
          const qty  = Number(line.qty || 0);
          const unit = Number(line.unitPrice || 0);
          const totalLine = qty * unit;

          if (!bucket[kind]){
            bucket[kind] = { qty:0, total:0, byName:new Map() };
          }
          const k = bucket[kind];
          k.qty   += qty;
          k.total += totalLine;

          const prevName = k.byName.get(name) || 0;
          k.byName.set(name, prevName + qty);
        });
      });

      const rows = [[
        'date',
        'type',
        'total_quantites',
        'total_ventes',
        'top3_articles'
      ]];

      const typeLabel = {
        pizza:   'pizza',
        drink:   'boisson',
        dessert: 'dessert',
        other:   'autre'
      };

      [...perDayType.entries()]
        .sort(([d1],[d2]) => d1.localeCompare(d2))
        .forEach(([day, types]) => {
          ['pizza','drink','dessert','other'].forEach(kind => {
            const data = types[kind];
            if (!data || !data.qty) return;

            const tops = [...data.byName.entries()]
              .sort((a,b) => b[1] - a[1])
              .slice(0,3)
              .map(([name, q]) => `${name} (${q})`)
              .join(', ');

            rows.push([
              day,
              typeLabel[kind] || kind,
              String(data.qty),
              String(data.total).replace('.', ','),
              tops
            ]);
          });
        });

      const csv  = rowsToCSV(rows);
      const html = rowsToHTMLTable(rows);
      const label = (start || end) ? `${start || ''} ‚Üí ${end || ''}` : todayISO();
      openExportPreview({
        title: `R√©sum√© journalier (${label})`,
        html,
        csv
      });
    }

    function exportTopClients(){
      const { start, end, orders } = getOrdersForStatsRange();

      if (!orders.length){
        alert('Aucune commande dans cette p√©riode.');
        return;
      }

      const map = new Map();

      orders.forEach(o => {
        const name = (o.client || '').trim() || 'Client inconnu';
        const phone = (o.phone || '').trim();
        const key = name + '|' + phone;

        const total = Number(o.total || 0);
        const at = o.at || new Date().toISOString();

        const prev = map.get(key) || {
          name,
          phone,
          orders: 0,
          total: 0,
          lastAt: at
        };
        prev.orders += 1;
        prev.total  += total;
        if (at > prev.lastAt) prev.lastAt = at;

        map.set(key, prev);
      });

      const list = [...map.values()].sort((a,b) => {
        if (b.orders !== a.orders) return b.orders - a.orders;
        return b.total - a.total;
      });

      const rows = [[
        'client',
        'telephone',
        'nb_commandes',
        'panier_moyen',
        'derniere_commande'
      ]];

      list.forEach(c => {
        const avg = c.orders ? (c.total / c.orders) : 0;
        rows.push([
          c.name,
          c.phone,
          String(c.orders),
          String(avg.toFixed(2)).replace('.', ','),
          new Date(c.lastAt).toLocaleString('fr-FR')
        ]);
      });

      const csv  = rowsToCSV(rows);
      const html = rowsToHTMLTable(rows);
      const label = (start || end) ? `${start || ''} ‚Üí ${end || ''}` : todayISO();
      openExportPreview({
        title: `Top clients (${label})`,
        html,
        csv
      });
    }

    function exportAvgSlotCSV(){
      const { start, end, orders } = getOrdersForStatsRange();
      if (!orders.length){
        alert('Aucune commande dans cette p√©riode.');
        return;
      }

      const map = new Map();
      orders.forEach(o => {
        const slot = o.slot || '‚Äî';
        const t = Number(o.total || 0);
        const prev = map.get(slot) || { orders:0, total:0 };
        prev.orders += 1;
        prev.total  += t;
        map.set(slot, prev);
      });

      const list = [...map.entries()].sort(([a],[b]) => a.localeCompare(b));

      const rows = [[
        'creneau',
        'panier_moyen',
        'nb_commandes',
        'total_ventes'
      ]];

      list.forEach(([slot, stats]) => {
        const avg = stats.orders ? (stats.total / stats.orders) : 0;
        rows.push([
          slot,
          String(avg.toFixed(2)).replace('.', ','),
          String(stats.orders),
          String(stats.total).replace('.', ',')
        ]);
      });

      const csv  = rowsToCSV(rows);
      const html = rowsToHTMLTable(rows);
      const label = (start || end) ? `${start || ''} ‚Üí ${end || ''}` : todayISO();
      openExportPreview({
        title: `Panier moyen par cr√©neau (${label})`,
        html,
        csv
      });
    }

    function exportProductMixCSV(){
      const { start, end, orders } = getOrdersForStatsRange();

      if (!orders.length){
        alert('Aucune commande dans cette p√©riode.');
        return;
      }

      const perProduct = new Map();
      const totalByKind = { pizza:0, drink:0, dessert:0, other:0 };

      orders.forEach(o => {
        (o.items || []).forEach(line => {
          const kind = lineKind(line) || 'other';
          const name = line.name || '???';
          const qty  = Number(line.qty || 0);
          const unit = Number(line.unitPrice || 0);
          const totalLine = qty * unit;

          const key = kind + ':' + name;
          const prev = perProduct.get(key) || { kind, name, qty:0, total:0 };
          prev.qty   += qty;
          prev.total += totalLine;
          perProduct.set(key, prev);

          if (totalByKind[kind] == null) totalByKind[kind] = 0;
          totalByKind[kind] += qty;
        });
      });

      if (!perProduct.size){
        alert('Aucun produit dans cette p√©riode.');
        return;
      }

      const typeLabel = {
        pizza:   'pizza',
        drink:   'boisson',
        dessert: 'dessert',
        other:   'autre'
      };

      const list = [...perProduct.values()].sort((a,b) => {
        if (a.kind !== b.kind) return a.kind.localeCompare(b.kind);
        return b.qty - a.qty;
      });

      const rows = [[
        'type',
        'produit',
        'quantite',
        'pourcentage_categorie',
        'prix_moyen'
      ]];

      list.forEach(p => {
        const totalKindQty = totalByKind[p.kind] || 1;
        const pct = (p.qty / totalKindQty) * 100;
        const avg = p.qty ? (p.total / p.qty) : 0;

        rows.push([
          typeLabel[p.kind] || p.kind,
          p.name,
          String(p.qty),
          String(pct.toFixed(1)).replace('.', ','),
          String(avg.toFixed(2)).replace('.', ',')
        ]);
      });

      const csv  = rowsToCSV(rows);
      const html = rowsToHTMLTable(rows);
      const label = (start || end) ? `${start || ''} ‚Üí ${end || ''}` : todayISO();
      openExportPreview({
        title: `Mix produits (${label})`,
        html,
        csv
      });
    }

    function exportWeekdayCSV(){
      const { start, end, orders } = getOrdersForStatsRange();

      if (!orders.length){
        alert('Aucune commande dans cette p√©riode.');
        return;
      }

      const names = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
      const stats = Array.from({length:7}, (_,i) => ({ orders:0, total:0 }));

      orders.forEach(o => {
        const d = new Date(o.at);
        const dow = d.getDay();
        const t = Number(o.total || 0);
        stats[dow].orders += 1;
        stats[dow].total  += t;
      });

      const rows = [[
        'jour',
        'nb_commandes',
        'total_ventes',
        'panier_moyen'
      ]];

      names.forEach((name, idx) => {
        const st = stats[idx];
        if (!st.orders && !st.total) return;
        const avg = st.orders ? (st.total / st.orders) : 0;
        rows.push([
          name,
          String(st.orders),
          String(st.total).replace('.', ','),
          String(avg.toFixed(2)).replace('.', ',')
        ]);
      });

      const csv  = rowsToCSV(rows);
      const html = rowsToHTMLTable(rows);
      const label = (start || end) ? `${start || ''} ‚Üí ${end || ''}` : todayISO();
      openExportPreview({
        title: `Ventes par jour de la semaine (${label})`,
        html,
        csv
      });
    }

    function exportTicketsChronoCSV(){
      const { start, end, orders } = getOrdersForStatsRange();

      if (!orders.length){
        alert('Aucune commande dans cette p√©riode.');
        return;
      }

      const list = orders.slice().sort((a,b) => {
        return new Date(a.at) - new Date(b.at);
      });

      const rows = [[
        'date',
        'heure',
        'ticket',
        'client',
        'total',
        'nb_articles'
      ]];

      list.forEach(o => {
        const d = new Date(o.at);
        const dateStr = d.toISOString().slice(0,10);
        const timeStr = d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
        const itemsCount = (o.items || []).reduce((s,l)=> s + (Number(l.qty)||0), 0);

        rows.push([
          dateStr,
          timeStr,
          o.ticket || '',
          o.client || '',
          String(o.total || 0).replace('.', ','),
          String(itemsCount)
        ]);
      });

      const csv  = rowsToCSV(rows);
      const html = rowsToHTMLTable(rows);
      const label = (start || end) ? `${start || ''} ‚Üí ${end || ''}` : todayISO();
      openExportPreview({
        title: `Tickets chronologiques (${label})`,
        html,
        csv
      });
    }

    function exportMonthlyCompareCSV(){
      const all = [...savedOrders, ...archivedOrders];
      if (!all.length){
        alert('Aucune commande.');
        return;
      }

      const perMonth = new Map();

      all.forEach(o => {
        const d = new Date(o.at);
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const key = `${y}-${m}`;
        const pizzas = countPizzasIn(o.items || []);
        const t = Number(o.total || 0);

        const prev = perMonth.get(key) || { month:key, orders:0, total:0, pizzas:0 };
        prev.orders += 1;
        prev.total  += t;
        prev.pizzas += pizzas;
        perMonth.set(key, prev);
      });

      const months = [...perMonth.values()].sort((a,b) => a.month.localeCompare(b.month));

      const rows = [[
        'mois',
        'commandes',
        'total_ventes',
        'pizzas',
        'variation_vs_mois_prec_%'
      ]];

      for (let i=0; i<months.length; i++){
        const cur = months[i];
        const prev = months[i-1];
        let varPct = '';
        if (prev && prev.total){
          const diff = ((cur.total - prev.total) / prev.total) * 100;
          varPct = String(diff.toFixed(1)).replace('.', ',');
        }
        rows.push([
          cur.month,
          String(cur.orders),
          String(cur.total).replace('.', ','),
          String(cur.pizzas),
          varPct
        ]);
      }

      const csv  = rowsToCSV(rows);
      const html = rowsToHTMLTable(rows);
      openExportPreview({
        title: 'Comparatif mensuel',
        html,
        csv
      });
    }

    /* ===== Admin JSON + D√©verrouillage ===== */
    function applyAdmin(){
      const txt = byId('adminJson').value;
      try{
        const obj = JSON.parse(txt);
        if(!obj || !Array.isArray(obj.pizzas) || !Array.isArray(obj.drinks) || !Array.isArray(obj.desserts)){
          alert('Format invalide: pizzas/drinks/desserts doivent √™tre des tableaux.');
          return;
        }
        CATALOG = obj;
        saveCatalog();
        renderMenu();
        updateSlotsCapacity();
        alert('Catalogue enregistr√©.');
      }catch(e){
        const m = /position\s+(\d+)/i.exec(e.message||'');
        if(m){
          const pos = Number(m[1]);
          const before = txt.slice(0, pos);
          const line = (before.match(/\n/g)||[]).length + 1;
          const col = pos - (before.lastIndexOf('\n')+1) + 1;
          alert(`JSON invalide (ligne ${line}, colonne ${col}) : ${e.message}`);
        }else{
          alert('JSON invalide: '+ e.message);
        }
      }
    }
    function exportCatalog(){
      const blob = new Blob([JSON.stringify(CATALOG,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download='catalogue_pizzeria.json'; a.click(); URL.revokeObjectURL(url);
    }
    function resetCatalog(){ if(!confirm('R√©initialiser le catalogue par d√©faut ?')) return; CATALOG = structuredClone(DEFAULT_CATALOG); saveCatalog(); renderMenu(); openAdmin(); updateSlotsCapacity(); }
    function openAdmin(){
      const data = JSON.stringify(CATALOG, null, 2);
      byId('adminJson').value = data;
      renderClientsAdmin();
      byId('adminModal').classList.add('open');
    }

    function syncUnlockToggle(){
      const ck = byId('unlockToggle');
      if (!ck) return;
      ck.checked = !!unlockSlots;
      ck.title = unlockSlots ? 'Mode d√©verrouill√© actif' : 'D√©verrouiller les cr√©neaux';
    }

    /* ===== Listeners globaux ===== */
    byId('resetOrder').addEventListener('click', resetOrder);
    byId('saveOrder').addEventListener('click', saveOrder);

    byId('exportJSON').addEventListener('click', ()=>{

      // Les donn√©es compl√®tes √† sauvegarder
      const jsonStr = JSON.stringify(savedOrders, null, 2);

      // ‚ûú on m√©morise la date du backup
      const snap = {
        createdAt: new Date().toISOString()
      };
      localStorage.setItem('pizzeria.fullBackup.latest', JSON.stringify(snap));
      updateLastBackupDisplay();

      const blob = new Blob([jsonStr], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;

      const d = new Date();
      const stamp =
        d.getFullYear() + "-" +
        String(d.getMonth()+1).padStart(2,"0") + "-" +
        String(d.getDate()).padStart(2,"0") + "_" +
        String(d.getHours()).padStart(2,"0") + "h" +
        String(d.getMinutes()).padStart(2,"0");

      a.download = `Backup_Pizzeria_${stamp}.json`;

      a.click();
      URL.revokeObjectURL(url);
    });

    byId('exportCSV').addEventListener('click', ()=>{
      const rows = [[
        'date',
        'ticket',
        'client',
        'telephone',
        'statut',
        'creneau',
        'article',
        'taille',
        'qt√©',
        'prix_unitaire',
        'total_ligne',
        'total_commande'
      ]];
      
      const allOrders = [...savedOrders, ...archivedOrders];
      allOrders.forEach(o=>{
        (o.items||[]).forEach(i=>{
          const lineTotal = (i.unitPrice||0) * (i.qty||0);
          rows.push([
            new Date(o.at).toLocaleString('fr-FR'),
            o.ticket||'',
            o.client||'',
            o.phone||'',
            o.status||'',
            o.slot||'',
            i.name||'',
            i.size||'',
            String(i.qty||0),
            String(i.unitPrice||0).replace('.',','),
            String(lineTotal).replace('.',','),
            String(o.total||0).replace('.',',')
          ]);
        });
      });

      const csv = rowsToCSV(rows);
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `commandes_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });

    byId('openAdmin').addEventListener('click', ()=>{
      openAdmin();
      syncUnlockToggle();
    });

    byId('closeAdmin').addEventListener('click', ()=>{
      const m = byId('adminModal');
      m.classList.remove('open');
    });
    byId('saveCatalog').addEventListener('click', applyAdmin);
    byId('exportCatalog').addEventListener('click', exportCatalog);
    byId('resetCatalog').addEventListener('click', resetCatalog);

    const _ec = byId('exportClients'); if(_ec) _ec.addEventListener('click', exportClients);
    const _rc = byId('refreshClients'); if(_rc) _rc.addEventListener('click', renderClientsAdmin);
    const _cc = byId('clearClients'); if(_cc) _cc.addEventListener('click', clearClients);

    document.addEventListener('change', (e)=>{
      if(e.target && e.target.id === 'unlockToggle'){
        unlockSlots = e.target.checked;
        localStorage.setItem('pizzeria.unlock', JSON.stringify(unlockSlots));
        updateSlotsCapacity();
        showHealth(
          unlockSlots
            ? 'D√©verrouillage des cr√©neaux ACTIV√â'
            : 'D√©verrouillage d√©sactiv√©',
          unlockSlots ? 'ok' : 'error',
          1800
        );
      }
    });

    // Raccourci : Shift + R pour mode suppression dans l‚Äôhistorique
    document.addEventListener('keydown', (e)=>{
      if (e.shiftKey && (e.key === 'R' || e.key === 'r')) {
        archiveDeleteMode = !archiveDeleteMode;

        const s = byId('archiveStart')?.value || '';
        const eDay = byId('archiveEnd')?.value || '';
        renderArchive(s, eDay);

        const clearBtn = byId('clearArchive');
        if (clearBtn) {
          clearBtn.style.display = archiveDeleteMode ? 'inline-flex' : 'none';
        }

        showHealth(
          archiveDeleteMode
            ? 'Mode suppression (historique) ACTIV√â'
            : 'Mode suppression (historique) d√©sactiv√©',
          archiveDeleteMode ? 'ok' : 'error',
          1800
        );
      }
    });

    byId('toggleTheme').addEventListener('click', ()=>{
      const next = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
      applyTheme(next, true);
    });

    document.querySelectorAll('.tab[data-cat]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab[data-cat]').forEach(b=> b.classList.remove('active'));
        btn.classList.add('active');
        currentCategory = btn.getAttribute('data-cat');
        renderMenu();
      });
    });

    byId('client').addEventListener('input', ()=>{ 
      updateFieldHints();
      handleClientChange();
    });

    byId('slot').addEventListener('input', updateFieldHints);
    byId('slot').addEventListener('change', updateFieldHints);

    byId('phone').addEventListener('input', ()=>{ 
      updateFieldHints();
      handlePhoneChange();
    });

    const _fs = byId('filterSlot');
    if (_fs) {
      _fs.addEventListener('change', renderSavedOrders);
    }

    byId('closeCfg').addEventListener('click', ()=> byId('configModal').classList.remove('open'));
    byId('cancelCfg').addEventListener('click', ()=> byId('configModal').classList.remove('open'));
    byId('cfgQty').addEventListener('input', (e)=>{ cfg.qty = Math.max(1, Number(e.target.value||1)); updateCfgPrice(); });
    byId('qtyMinus').addEventListener('click', ()=>{ byId('cfgQty').value = Math.max(1, Number(byId('cfgQty').value)-1); byId('cfgQty').dispatchEvent(new Event('input')); });
    byId('qtyPlus').addEventListener('click', ()=>{ byId('cfgQty').value = Number(byId('cfgQty').value)+1; byId('cfgQty').dispatchEvent(new Event('input')); });
    document.addEventListener('click', (e)=>{
      if(e.target.matches('.chip-btn[data-size]') && e.target.closest('#configModal .quick-actions')){
        cfg.size = e.target.getAttribute('data-size'); updateCfgPrice();
      }
    });
    byId('addCfg').addEventListener('click', ()=>{
      const p = CATALOG.pizzas.find(x=>x.id===cfg.pizzaId); if(!p) return;
      const unitPrice = p.base[cfg.size] + cfg.toppings.length * (CATALOG.toppingPrice||0);
      const key = `pizza:${p.id}:${cfg.size}:${cfg.toppings.slice().sort().join('+')}`;
      const noteText = (byId('notes').value || '').trim();
      addOrIncrement(key, ()=>({
        id: crypto.randomUUID(),
        kind:'pizza',
        pizzaId: p.id,
        name:p.name,
        size:cfg.size,
        qty:cfg.qty,
        toppings:[...cfg.toppings],
        note: noteText,
        unitPrice
      }));
      byId('configModal').classList.remove('open');
    });

    const _os = byId('openStats'); if(_os) _os.addEventListener('click', openStats);
    const _cs = byId('closeStats'); if(_cs) _cs.addEventListener('click', ()=> byId('statsModal').classList.remove('open'));

    const _exs = byId('exportStats'); if (_exs) _exs.addEventListener('click', exportStatsCSV);
    const _exbd = byId('exportDrinksDesserts'); if (_exbd) _exbd.addEventListener('click', exportDrinksDessertsCSV);
    const _exDaily = byId('exportDailyTypes'); if (_exDaily) _exDaily.addEventListener('click', exportDailyTypesCSV);
    const _exTopClients = byId('exportTopClients'); if (_exTopClients) _exTopClients.addEventListener('click', exportTopClients);
    const _exAvgSlot = byId('exportAvgSlot'); if (_exAvgSlot) _exAvgSlot.addEventListener('click', exportAvgSlotCSV);
    const _exMix = byId('exportProductMix'); if (_exMix) _exMix.addEventListener('click', exportProductMixCSV);
    const _exWeek = byId('exportWeekday'); if (_exWeek) _exWeek.addEventListener('click', exportWeekdayCSV);
    const _exTickets = byId('exportTicketsChrono'); if (_exTickets) _exTickets.addEventListener('click', exportTicketsChronoCSV);
    const _exMonth = byId('exportMonthlyCompare'); if (_exMonth) _exMonth.addEventListener('click', exportMonthlyCompareCSV);

    const _oa = byId('openArchive'); if(_oa) _oa.addEventListener('click', openArchive);
    const _ca = byId('closeArchive'); if(_ca) _ca.addEventListener('click', ()=> byId('archiveModal').classList.remove('open'));
    const _clear = byId('clearArchive'); if (_clear) _clear.addEventListener('click', clearArchive);
    const _exportArch = byId('exportArchive'); if (_exportArch) _exportArch.addEventListener('click', exportArchiveCSV);

    const _viewDetail = byId('archiveViewDetail');
    const _viewDaily  = byId('archiveViewDaily');

    function syncArchiveViewTabs(){
      if (!_viewDetail || !_viewDaily) return;
      _viewDetail.classList.toggle('active', archiveViewMode === 'detail');
      _viewDaily.classList.toggle('active', archiveViewMode === 'daily');
    }

    if (_viewDetail) {
      _viewDetail.addEventListener('click', ()=>{
        archiveViewMode = 'detail';
        syncArchiveViewTabs();
        const s = byId('archiveStart')?.value || '';
        const e = byId('archiveEnd')?.value || '';
        renderArchive(s, e);
      });
    }

    if (_viewDaily) {
      _viewDaily.addEventListener('click', ()=>{
        archiveViewMode = 'daily';
        syncArchiveViewTabs();
        const s = byId('archiveStart')?.value || '';
        const e = byId('archiveEnd')?.value || '';
        renderArchive(s, e);
      });
    }

    // Modale aper√ßu exports
    const _closePrev = byId('closeExportPreview');
    if (_closePrev) _closePrev.addEventListener('click', closeExportPreview);
    const _dlPrev = byId('exportPreviewDownload');
    if (_dlPrev) _dlPrev.addEventListener('click', () => {
      if (!currentPreviewCSV) return;
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + currentPreviewCSV], { type:'text/csv;charset=utf-8;' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href = url;
      a.download = 'export.csv';
      a.click();
      URL.revokeObjectURL(url);
    });

    window.addEventListener('error', (e)=>{ try{ showHealth('Erreur JS : '+ e.message, 'error'); }catch(_){} });
    window.addEventListener('unhandledrejection', (e)=>{ try{ const msg = (e.reason && (e.reason.message||e.reason)) || 'Rejet de promesse'; showHealth('Erreur : '+ msg, 'error'); }catch(_){} });

    function selfTests(){
      try{
        if(!CATALOG || !Array.isArray(CATALOG.pizzas) || CATALOG.pizzas.length===0) throw new Error('Catalogue pizzas vide');
        const slotSel = byId('slot');
        const optCount = slotSel.options.length;
        if(optCount < 5) throw new Error('Cr√©neaux non g√©n√©r√©s');
        const grid = byId('menuGrid');
        if(grid.children.length === 0) throw new Error('Menu non rendu');
        showHealth('Interface pr√™te', 'ok', 1500);
      }catch(err){ showHealth('Test: '+err.message, 'error'); }
    }

    function updateLastBackupDisplay(){
      const info = byId('lastBackupInfo');
      if (!info) return;

      const raw = localStorage.getItem('pizzeria.fullBackup.latest');
      if (!raw){
        info.textContent = "Aucune sauvegarde encore effectu√©e";
        return;
      }

      try {
        const snap = JSON.parse(raw);
        const d = new Date(snap.createdAt || Date.now());
        const date = d.toLocaleDateString('fr-FR');
        const time = d.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
        info.textContent = `Derni√®re sauvegarde : ${date} √† ${time}`;
      } catch(e){
        info.textContent = "Derni√®re sauvegarde : impossible de lire les donn√©es";
      }
    }

    function boot(){
      try{
        applyTheme(getPreferredTheme(), false);
        loadCatalog();
        loadClients();
        renderMenu();
        loadOrders();
        loadArchived();
        loadCart();
        renderOrderTable();
        buildSlots();
        updateFieldHints();
        setTimeout(selfTests, 50);
        updateLastBackupDisplay();
      }catch(e){
        console.error(e);
        showHealth('Erreur au d√©marrage : '+ (e.message||e), 'error');
      }
    }
    if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', boot); }
    else { boot(); }
  </script>
</body>
</html>
